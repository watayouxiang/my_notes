## 一、H264结构与码流解析

### 1.1 H264结构图

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63a67134328b43718fea2d6ef8fa1f83~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

上图`H264结构`中，一个视频图像编码后的数据叫做`一帧`，`一帧`由`一个片（slice）或多个片`组成，`一个片`又由`一个或多个宏块（MB）`组成，`一个宏块`由多个`子块`组成，子块即`16x16的yuv数据`。**宏块是作为H264编码的基本单位**。

- `场和帧`：视频的一场或一帧可用来产生一个编码图像。
- `片`:每个图象中，若干宏块被排列成片的形式。片分为`I片、B片、P片`和`其他一些片`。
  - I片只包含I宏块，P片可包含P和I宏块，而B片可包含B和I宏块。
    - I宏块利用从当前片中已解码的像素作为参考进行帧内预测。
    - P宏块利用前面已编码图象作为参考图象进行帧内预测。
    - B宏块则利用双向的参考图象（前一帧和后一帧）进行帧内预测。
  - 片的目的是为了限制误码的扩散和传输，使编码片相互间是独立的。某片的预测不能以其它片中的宏块为参考图像，这样某一片中的预测误差才不会传播到其它片中去。
- 宏块:一个编码图像通常划分成若干宏块组成，一个宏块由一个16×16亮度像素和附加的一个8×8 Cb和一个8×8 Cr彩色像素块组成。

### 1.2 H264编码分层

**H264编码分层,分为了2层**.

- **NAL层:** **(Network Abstraction Layer,视频数据网络抽象层)**
  - 它的作用是H264只要在网络上传输,在传输的过程每个包以太网是1500字节. 而H264的帧往往会大于1500字节的.所以就要进行`拆包`. 将一个帧拆成多个包进行传输.所有的`拆包或者组包`都是通过`NAL层`去处理的.
- **VCL层:(Video Coding Layer,视频数据编码层)** 它的作用就是对视频原始数据进行压缩.

### 1.3 码流的基本概念

- **SODB:(String of Data Bits,原始数据比特流)** ,长度不一定是8的倍数.它是由VCL层产生的.因为非8的倍数所以处理比较麻烦.
- **RBSP:(Raw Byte Sequence Payload,SODB+trailing bits)** .算法是在SODB最后一位补1.不按字节对齐补0. 如果补齐0,不知道在哪里结束.所以补1.如果不够8位则按位补0.
- **EBSP:(Encapsulate Byte Sequence Payload)** .就是生成压缩流之后,我们还要在每个帧之前加一个起始位.起始位一般是十六进制的`0001`.但是在整个编码后的数据里,可能会出来`连续的2个0x00`.那这样就与起始位产生了`冲突`.那怎么处理了? H264规范里说明如果处理2个连续的0x00,就`额外增加一个0x03`.这样就能预防压缩后的数据与起始位产生冲突.
- **NALU: NAL Header(1B)+EBSP**.NALU就是在EBSP的基础上加1B的网络头.

**EBSP解码的要点**

- 每个NAL前有一个起始码 `0x00 00 01`（或者`0x00 00 00 01`），解码器检测每个起始码，作为一个NAL的起始标识，当检测到下一个起始码时，当前NAL结束。
- 同时H.264规定，当检测到`0x00 00 01`时，也可以表征`当前NAL的结束`。那么NAL中数据出现`0x000001`或`0x000000`时怎么办？H.264引入了防止竞争机制，如果编码器检测到NAL数据存在`0x000001或0x000000`时，编码器会在最后个字节前插入一个新的字节`0x03`，这样解码器检测到`0x000003`时，把`03抛弃`，恢复原始数据（`脱壳`操作）。
- 解码器在解码时，首先`逐个字节读取`NAL的数据，统计NAL的`长度`，然后再开始解码。

### 1.4 详解NAL Unit

NALU详解结构图如下：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a08a70f9e2f4defbd44fecd010300f6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

- NAL 单元是由一个NALU头部+一个切片.
- 切片又可以细分成"切片头+切片数据".
- 每个切片数据包括了很多宏块.
- 每个宏块包括了宏块的类型,宏块的预测,残差数据.

#### H264码流分层结构图

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39f8e20747764334b8eb15b5b4ed4adb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

- **A Annex格式数据**: 就是起始码+Nal Unit 数据
- **NAL Unit**: NALU 头+NALU数据
- **NALU 主体**: 是由切片组成.切片包括切片头+切片数据
- **Slice数据**: 宏块组成
- **PCM类**: 宏块类型+pcm数据,或者宏块类型+宏块模式+残差数据
- **Residual**: 残差块

> ⚠️ 这个图比较重要.大家可以多看看。


作者：深圳_你要的昵称
链接：https://juejin.cn/post/7009100729994444837
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。