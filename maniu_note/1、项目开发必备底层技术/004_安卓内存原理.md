[TOC]

# åå°„

1ã€javaæ–¹æ³•ä¸æŒ‡ä»¤é›†ï¼ˆjavaä¸­æ˜¯armæŒ‡ä»¤ï¼Œå®‰å“ä¸­æ˜¯dexæŒ‡ä»¤ï¼‰

2ã€æ·±å…¥è™šæ‹Ÿæœºå‰–æMethodåå°„æºç 

3ã€invokeæ–¹æ³•æ‰§è¡ŒåŸç†

4ã€åå°„å®ç°è·å–ç±»æ–¹æ³•ã€ç±»å˜é‡ä¸ç±»ç»“æ„æ–¹æ³•

## 1ã€JVMé¢è¯•é¢˜

### 1ï¼‰ä»å†…å­˜è§’åº¦è®²javaä¸ºä»€ä¹ˆè¦è®¾è®¡classå’Œobject

å‡å¦‚æ²¡æœ‰classï¼Œé‚£ä¹ˆæ¯ä¸ª â€œå¯¹è±¡â€ éƒ½æœ‰ä¸€ä»½ç›¸åŒçš„ â€œç±»ä¿¡æ¯â€ï¼Œå°±ä¼šé€ æˆå†…å­˜çˆ†æ£šã€‚

å‡å¦‚æ²¡æœ‰ â€œå¯¹è±¡â€ï¼Œè™½ç„¶èŠ‚çœäº† â€œå†…å­˜â€ ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªå¯¹è±¡éƒ½èƒ½é€šè¿‡ä¿®æ”¹å…¬å…±ä¿¡æ¯ï¼Œä»è€Œæ”¹å˜å…¶ä»–å¯¹è±¡çš„å€¼ï¼ˆå…¬å…±ä¿¡æ¯å­˜åœ¨classé‡Œï¼Œå·®å¼‚ä¿¡æ¯å­˜åœ¨objecté‡Œï¼‰ã€‚

### 2ï¼‰javaå†…å­˜åˆ†ä¸ºå“ªäº›éƒ¨åˆ†

<img src="004_å®‰å“å†…å­˜åŸç†.assets/image-20220302110522584.png" width="650" />

- æ–¹æ³•åŒºï¼ˆä¸»å­˜ã€çº¿ç¨‹å…±äº«åŒºï¼‰
  - ç±»ä¿¡æ¯ã€é™æ€å˜é‡ã€å…¨å±€å˜é‡ã€å¸¸é‡æ± ã€å¤„ç†é€»è¾‘çš„æŒ‡ä»¤é›†
- å †ï¼ˆä¸»å­˜ã€çº¿ç¨‹å…±äº«åŒºï¼‰
  - å¯¹è±¡å®ä¾‹
- è™šæ‹Ÿæœºæ ˆï¼ˆé«˜é€Ÿç¼“å­˜åŒºã€çº¿ç¨‹ç§æœ‰åŒºï¼‰
  - å­˜æ”¾æ–¹æ³•è¿è¡Œæ‰€éœ€çš„æ•°æ®
  - æ¯æ¬¡å¼€ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ª **è™šæ‹Ÿæœºæ ˆ**ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒ
  - åœ¨æ‰§è¡Œæ¯ä¸ªæ–¹æ³•çš„æ—¶ï¼Œä¼šæŠŠæ–¹æ³•æ‰“åŒ…æˆä¸€ä¸ª **æ ˆå¸§**
  - æ ˆå¸§åŒ…å«å››ä¸ªåŒºåŸŸï¼š**å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•è¿”å›åœ°å€**
- æœ¬åœ°æ–¹æ³•æ ˆï¼ˆé«˜é€Ÿç¼“å­˜åŒºã€çº¿ç¨‹ç§æœ‰åŒºï¼‰
  - nativeæ–¹æ³•
- ç¨‹åºè®¡æ•°å™¨ï¼ˆçº¿ç¨‹ç§æœ‰åŒºï¼‰
  - è®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œåˆ°çš„å­—èŠ‚ç è¡Œå·

### 3ï¼‰javaä¸ºä»€ä¹ˆè¦æœ‰æ–¹æ³•åŒºå’Œå †åŒº

javaæœ€å¤§çš„ä¼˜åŠ¿æ˜¯JVMè‡ªåŠ¨ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè®¾è®¡æ–¹æ³•åŒºå’Œå †åŒºæ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†ã€‚

å‡å¦‚æ²¡æœ‰æ–¹æ³•åŒºï¼Œæ¯æ¬¡åˆ›å»ºå¯¹è±¡éƒ½è¦ä»ç£ç›˜åŠ è½½å­—èŠ‚ç ï¼Œç„¶ånewå‡ºæ¥ï¼Œæ€§èƒ½ä½ä¸‹ã€‚

å‡å¦‚æ²¡æœ‰å †åŒºï¼Œæ¯æ¬¡åˆ›å»ºéƒ½è¦åŠ è½½ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æºå¸¦å¯¹åº”çš„classï¼Œç›¸å½“æ¶ˆè€—å†…å­˜ã€‚

### 4ï¼‰String str = new String("123") åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡

```
String str = new String("123"); // åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ï¼Ÿ

// åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ã€‚
// "123"æ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼ˆé™æ€å¯¹è±¡ï¼‰ï¼Œå­˜æ”¾åœ¨æ–¹æ³•åŒºã€‚
// str æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡å­˜æ”¾åœ¨å †åŒºã€‚
// å› æ­¤è¯¥è¡Œä»£ç åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ã€‚
```

### 5ï¼‰ä¸ºä»€ä¹ˆâ€œå¯¹è±¡æ–¹æ³•è°ƒç”¨çš„é€Ÿåº¦â€è¿œå¿«äºâ€œåå°„æ–¹æ³•è°ƒç”¨çš„é€Ÿåº¦â€

>  javaæ–¹æ³•æ˜¯ä¸€ç³»åˆ—æŒ‡ä»¤çš„é›†åˆ

**ç›´æ¥è°ƒç”¨æ–¹æ³•**

```java
public class Person {
    public void run() {
        Person person = new Person();
        person.test();
        person.test2();
        person.test3();
        person.test4();
        person.test5();
    }

    public void test() {
    }
    public void test2() {
    }
    public void test3() {
    }
    public void test4() {
    }
    public void test5() {
    }
}
```

```java
Person.run:()V:
regs: 0002; ins: 0001; outs: 0001
  0000: new-instance v0, Person // type@0000
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
    
  // ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªæ–¹æ³•çš„æŒ‡ä»¤éƒ½æœ‰å¯¹åº”çš„å­˜æ”¾åœ°å€ï¼ˆmethod@0002ã€method@0003...ï¼‰
  // method@0002ã€method@0003...method@0006ï¼šè¿™ä¸ªå°±æ˜¯â€œæ–¹æ³•è¡¨â€ï¼Œâ€œæ–¹æ³•è¡¨â€å­˜æ”¾åœ¨â€œæ–¹æ³•åŒºâ€
  // Person.classä¸­æœ‰å¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•ä¼šè¢«å°è£…æˆä¸€ä¸ªä¸ªArtMethodå¯¹è±¡ã€‚ä¸€ä¸ªä¸ªArtMethodå¯¹è±¡å°±ç»„æˆäº†æ–¹æ³•è¡¨ã€‚
  // 
  // å¯¹è±¡ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼šå¯ä»¥é€šè¿‡è¯¥åœ°å€æ‰¾åˆ°æŒ‡ä»¤ï¼ˆæ— éœ€åŒ¹é…ã€å¯¹æ¯”ã€æ ¡éªŒæŒ‡ä»¤ï¼‰ï¼Œå› æ­¤è°ƒç”¨å°±å¿«
  0005: invoke-virtual {v0}, Person.test:()V // method@0002
  0008: invoke-virtual {v0}, Person.test2:()V // method@0003
  000b: invoke-virtual {v0}, Person.test3:()V // method@0004
  000e: invoke-virtual {v0}, Person.test4:()V // method@0005
  0011: invoke-virtual {v0}, Person.test5:()V // method@0006
    
  0014: return-void
```

**åå°„è°ƒç”¨æ–¹æ³•**

```java
public static void main(String[] args) {
    Class<?> clazz = null;
    try {
        for (int i = 0; i < 1000; i++) {
            // è¿™é‡Œæœ‰æ‡’åŠ è½½æœºåˆ¶ï¼Œæ‰€ä»¥ä»…ä»…ç¬¬ä¸€æ¬¡æ…¢
            clazz = Class.forName("com.wata.demo.Person");
            // è¿™ä¸€æ­¥æ€§èƒ½æœ€å·®
          	// å› ä¸ºåå°„éœ€è¦ï¼š1ï¼‰æ ¹æ®æ–¹æ³•åæ‰¾åˆ°å¯¹åº”çš„æŒ‡ä»¤ 
          	//						 2ï¼‰åŒ¹é…æŒ‡ä»¤
          	//						 3ï¼‰å¯¹æ¯”æŒ‡ä»¤
          	//						 4ï¼‰æ ¡éªŒç­¾å
            Method method = clazz.getMethod("test");
            method.invoke(null);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

### 6ï¼‰ä¸ºä»€ä¹ˆnew Threadæ¯”è¾ƒè´¹æ€§èƒ½

æ¯æ¬¡å¼€ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼ˆæ ˆåœ¨é«˜é€Ÿç¼“å­˜åŒºï¼Œå¤§å°ä¸º8kï¼‰ã€‚å½“çº¿ç¨‹æ‰§è¡Œç»“æŸåï¼Œåˆä¼šé”€æ¯å¯¹åº”çš„è™šæ‹Ÿæœºæ ˆã€‚å› æ­¤new Threadçš„æ–¹å¼æ˜¯æ¯”è¾ƒè´¹æ€§èƒ½çš„ã€‚

- è™šæ‹Ÿæœºä¸­çš„æ ˆæ˜¯æœ‰å¤šä¸ªçš„ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„æ ˆã€‚

- å‡å¦‚ä¸€ä¸ªcpuæœ‰å››æ ¸ï¼Œé‚£ä¹ˆåŒä¸€æ—¶é—´åªèƒ½è¿è¡Œå››ä¸ªçº¿ç¨‹ã€‚
- è™šæ‹Ÿæœºæ ˆä¹Ÿå«åš â€œæ ˆå¸§â€ã€‚

### 7ï¼‰ä¸ºä»€ä¹ˆå¦‚ä¸‹å•ä¾‹ä¼šå‘ç”ŸRuntimeException

```java
// å½“å‘ç”ŸæŒ‡ä»¤é‡æ’æ—¶ï¼Œä¼šå‘ç”Ÿ RuntimeExceptionï¼Œæ¦‚ç‡å¤§æ¦‚æ˜¯ä¸€ä¸‡åˆ†ä¹‹ä¸€ã€‚
// 
// RuntimeException å‘ç”Ÿçš„åŸå› ï¼š
// 		æ­£å¸¸æƒ…å†µä¸‹æ˜¯å…ˆ â€œè°ƒç”¨Personçš„æ„é€ æ–¹æ³•â€ï¼Œå† â€œè®¿é—®Personå¯¹è±¡â€ã€‚
//		è€Œå¦‚ä¸‹å•ä¾‹ä»£ç åœ¨å¤šçº¿ç¨‹è®¿é—®æ—¶ä¼šå‘ç”ŸæŒ‡ä»¤é‡æ’ï¼Œæœ‰å¯èƒ½å‘ç”Ÿå…ˆ â€œè®¿é—®Personå¯¹è±¡â€ï¼Œå† â€œè°ƒç”¨Personçš„æ„é€ æ–¹æ³•â€ï¼Œä»è€Œé€ æˆ RuntimeExceptionã€‚
//
// è§£å†³ RuntimeException çš„åŠæ³•ï¼š
// 		private static volatile Person instance;// åŠ volatileå¯ä»¥é¿å…æŒ‡ä»¤é‡æ’
// 
public class Person {
    private static Person instance;

    public static Person getInstance() {
        if (instance == null) {
            synchronized (Person.class) {
                if (instance == null) {
                    instance = new Person();
                }
            }
        }
        return instance;
    }
}
```

```java
// Person.getInstanceçš„æŒ‡ä»¤é›†çœ‹ä¸æ‡‚ ğŸ˜­ğŸ˜­ğŸ˜­

Person.getInstance:()LPerson;:
regs: 0002; ins: 0000; outs: 0001
  0000: sget-object v0, Person.instance:LPerson; // field@0000
  0002: if-nez v0, 0013 // +0011
  0004: const-class v1, Person // type@0000
  0006: monitor-enter v1
  0007: sget-object v0, Person.instance:LPerson; // field@0000
  0009: if-nez v0, 0012 // +0009
  000b: new-instance v0, Person // type@0000
  000d: invoke-direct {v0}, Person.<init>:()V // method@0000
  0010: sput-object v0, Person.instance:LPerson; // field@0000
  0012: monitor-exit v1
    
  0013: sget-object v0, Person.instance:LPerson; // field@0000
  0015: return-object v0
```

## 2ã€å°†androidæ–¹æ³•è½¬æ¢æˆdexæŒ‡ä»¤

> - ç¡¬ä»¶è¯»å†™é€Ÿåº¦æ¯”è¾ƒï¼šcpu > é«˜é€Ÿç¼“å­˜ > ä¸»å­˜
>   - é«˜é€Ÿç¼“å­˜é€Ÿåº¦è·Ÿcpuå·®ä¸å¤šï¼Œæ‰€ä»¥cpuå¯ä»¥ç›´æ¥è·Ÿé«˜é€Ÿç¼“å­˜æ‰“äº¤é“
>   - ä¸»å­˜é€Ÿåº¦è¿œè¿œæ…¢äºcpuï¼Œæ‰€ä»¥å¿…é¡»é€šè¿‡é«˜é€Ÿç¼“å­˜æ‰èƒ½è·Ÿcpuæ‰“äº¤é“
> - å¦‚ä½•è·å–dexæŒ‡ä»¤ï¼šjava --> class --> dex
>   - javaç»è¿‡javacç¼–è¯‘å¾—åˆ°.classæ–‡ä»¶
>   - .classæ–‡ä»¶ç»è¿‡dexç¼–è¯‘å¾—åˆ°dexæŒ‡ä»¤
> - dxå‘½ä»¤è·¯å¾„ï¼š/Users/TaoWang/Library/Android/sdk/build-tools/26.0.2/dx

### 1ï¼‰æ·»åŠ dxçš„ä¸´æ—¶ç¯å¢ƒå˜é‡

```java
// æ·»åŠ  /Users/TaoWang/Library/Android/sdk/build-tools/26.0.2/ åˆ°ä¸´æ—¶ç¯å¢ƒå˜é‡
$ export PATH=$PATH:/Users/TaoWang/Library/Android/sdk/build-tools/26.0.2/

// æ‰§è¡Œdxå‘½ä»¤ï¼Œå¦‚æœæ­£ç¡®è¾“å…¥ï¼Œè¯´æ˜ç¯å¢ƒé…ç½®æ­£ç¡®
$ dx
```

### 2ï¼‰javaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶

```java
// 1ã€ç¼–è¾‘ Person.java æ–‡ä»¶
// æ³¨æ„ï¼šæ”¾åœ¨æ ¹ç›®å½•ï¼Œä¸è¦æœ‰åŒ…å
public class Person {
    public void run() {
        Person person = new Person();
        person.test();
    }

    public void test() {
    }
}


// 2ã€å°† Person.java ç¼–è¯‘æˆ Person.class
// Build -> Mack Project ç”Ÿæˆclassæ–‡ä»¶ï¼š/builld/intermediates/javac/debug/classes/Person.class
```

### 3ï¼‰å°†classæ–‡ä»¶è½¬æˆdexæŒ‡ä»¤

```java
// 1ã€è¿›å…¥åˆ° Person.class æ‰€åœ¨ç›®å½•
$ cd /Users/TaoWang/Desktop/Demo/app/build/intermediates/javac/debug/classes 

// 2ã€ç”ŸæˆPerson.runçš„dexæŒ‡ä»¤
// --dexï¼šç¼–è¯‘æˆdex
// --verboseï¼šç¼–è¯‘è¿‡ç¨‹ä¸­æ‰“å°ä¿¡æ¯
// --dump-to=wata.txtï¼šè¾“å‡ºåˆ°wata.txt
// --dump-method=Person.runï¼šç¼–è¯‘çš„æ˜¯Person.runæ–¹æ³•
// --verbose-dump Person.classï¼šè¾“å…¥çš„ç±»è·¯å¾„
$ dx --dex --verbose --dump-to=wata.txt --dump-method=Person.run --verbose-dump Person.class

// 3ã€wata.txtçš„å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š
// wata.txt ä¸­å­˜æ”¾çš„æ˜¯Person.runçš„dexæŒ‡ä»¤
Person.run:()V:
regs: 0002; ins: 0001; outs: 0001
  0000: code-address
  0000: local-snapshot
  0000: code-address
  0000: code-address
  0000: local-snapshot
  0000: local-start v1 "this": Person
  0000: code-address
  0000: code-address
  0000: local-snapshot
          v1 "this": Person
  0000: code-address
  0000: new-instance v0, Person // type@0000
  0002: code-address
  0002: code-address
  0002: local-snapshot
          v1 "this": Person
  0002: code-address
  0002: code-address
  0002: local-snapshot
          v1 "this": Person
  0002: code-address
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
  0005: code-address
  0005: code-address
  0005: local-snapshot
          v1 "this": Person
  0005: local-start v0 "person": Person
  0005: code-address
  0005: invoke-virtual {v0}, Person.test:()V // method@0002
  0008: code-address
  0008: code-address
  0008: local-snapshot
          v0 "person": Person
          v1 "this": Person
  0008: return-void
  0009: code-address
  debug info
    line_start: 3
    parameters_size: 0000
    0000: prologue end
    0000: line 3
    0005: line 4
    0005: +local v0 person Person
    0008: line 5
    end sequence
  source file: "Person.java"

// 4ã€åˆ é™¤wata.txtä¸­çš„ä¸é‡è¦ä¿¡æ¯åå¦‚ä¸‹ï¼š
// 0000ã€0002ã€0005...0009 æ˜¯ç¨‹åºè®¡æ•°å™¨
// åˆ é™¤æ‰çš„éƒ¨åˆ†æ˜¯ dexæ—¥å¿—
Person.run:()V:
regs: 0002; ins: 0001; outs: 0001
  0000: new-instance v0, Person // type@0000
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
  0005: invoke-virtual {v0}, Person.test:()V // method@0002
  0008: return-void

```

## 3ã€è§£è¯»dexæŒ‡ä»¤

å±€éƒ¨å˜é‡åœ¨æ ˆåŒºï¼ˆé«˜é€Ÿç¼“å­˜åŒºï¼‰ï¼Œå…¨å±€å˜é‡åœ¨æ–¹æ³•åŒºï¼ˆä¸»å­˜ï¼‰ï¼Œå¯¹è±¡åœ¨å †åŒºï¼ˆä¸»å­˜ï¼‰ã€‚

### 1ï¼‰å±€éƒ¨å˜é‡

```java
public class Person {
    public void run() {
        Person person = new Person();
        person.test();
    }

    public void test() {
    }
}
```

```java
Person.run:()V:
regs: 0002; ins: 0001; outs: 0001

  // è¿™å¥æŒ‡ä»¤çš„å«ä¹‰ï¼š
  // å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡Personï¼Œç”¨æ¸¸æ ‡v0æŒ‡å‘è¯¥å¯¹è±¡
  //
  // å¯ä»¥å¾—å‡ºçš„ç»“è®ºï¼š
  // ç»“è®º1ï¼šç”±äºv0æ˜¯å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥v0å­˜æ”¾åœ¨æ ˆåŒºï¼ˆé«˜é€Ÿç¼“å­˜ï¼‰ä¸­
  // ç»“è®º2ï¼šæ— è®ºjavaå˜é‡åå¤šä¹ˆçš„é•¿ï¼Œç¼–è¯‘æˆdexæŒ‡ä»¤åæ˜¯ä¸€æ ·ï¼ˆå¯ä»¥è¯•éªŒå¾—å‡ºï¼‰
  // 
  // æ‰§è¡Œæ­¥éª¤ï¼š
  // ç¬¬ä¸€æ­¥ï¼šæ ˆåŒºä¸­ç”³æ˜ä¸€ä¸ªå˜é‡v0ï¼ˆæ ˆåŒº - é«˜é€Ÿç¼“å­˜ï¼‰
  // ç¬¬äºŒæ­¥ï¼šä¼šå°†Person.classåŠ è½½è¿›æ–¹æ³•åŒºï¼ˆæ–¹æ³•åŒº - ä¸»å­˜ï¼‰
  // ç¬¬ä¸‰æ­¥ï¼šåœ¨å †åŒºå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡Personï¼ˆå †åŒº - ä¸»å­˜ï¼‰
  // ç¬¬å››æ­¥ï¼šå°†v0æŒ‡å‘Personå¯¹è±¡
  0000: new-instance v0, Person // type@0000
  
  // æ‰§è¡Œæ­¥éª¤ï¼š
  // ç¬¬ä¸€æ­¥ï¼šé€šè¿‡å–åœ°å€ç¬¦ {v0} æ‹¿åˆ°å †åŒºçš„Personå¯¹è±¡
  // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å¯¹è±¡
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
  
  0005: invoke-virtual {v0}, Person.test:()V // method@0002
  0008: return-void
```

### 2ï¼‰å…¨å±€å˜é‡

```java
public class Person {
    private Person person;

    public void run() {
        person = new Person();
        person.test();
    }

    public void test() {
    }
}
```

```java
Person.run:()V:
regs: 0002; ins: 0001; outs: 0001
  
  // æ‰§è¡Œæ­¥éª¤ï¼š
  // 1ï¼‰åœ¨å †åŒºå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡Person
  // 2ï¼‰æ ˆåŒºç”³æ˜ä¸€ä¸ªå˜é‡v0
  // 3ï¼‰v0æŒ‡å‘å¯¹è±¡Person
  0000: new-instance v0, Person // type@0000
  
  // æ‰§è¡Œæ­¥éª¤ï¼š
  // 1ï¼‰é€šè¿‡å–åœ°å€ç¬¦ {v0} æ‹¿åˆ°å †åŒºçš„å¯¹è±¡Person
	// 2ï¼‰è°ƒç”¨å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
      
  // æ³¨æ„ï¼šå› ä¸ºç”³æ˜äº†ä¸€ä¸ªå…¨å±€å˜é‡Personï¼Œæ‰€ä»¥åœ¨æ–¹æ³•åŒºä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡v1
  // 			- v0åœ¨æ ˆåŒºï¼ˆé«˜é€Ÿç¼“å­˜ï¼‰ï¼ŒæŒ‡å‘Personå¯¹è±¡
  // 			- Personå¯¹è±¡åœ¨å †åŒºï¼ˆä¸»å­˜ï¼‰
  // 			- v1åœ¨æ–¹æ³•åŒºï¼ˆä¸»å­˜ï¼‰ï¼Œåœ¨æ‰§è¡Œè¯¥è¡ŒæŒ‡ä»¤å‰æš‚æ— æŒ‡å‘
  //
  // æ‰§è¡Œæ­¥éª¤ï¼š
  // 1ï¼‰æŠŠv0çš„å€¼èµ‹å€¼ç»™v1ï¼ˆæ­¤æ—¶v1çš„å€¼å°±ç­‰äºv0ï¼Œç”±äºv0æŒ‡å‘Personå¯¹è±¡ï¼Œæ‰€ä»¥v1ä¹ŸæŒ‡å‘Personå¯¹è±¡ï¼‰
  0005: iput-object v0, v1, Person.person:LPerson; // field@0000

  0007: iget-object v0, v1, Person.person:LPerson; // field@0000
  0009: invoke-virtual {v0}, Person.test:()V // method@0002
  000c: return-void
```

### 3ï¼‰å±€éƒ¨è¿”å›

```java
public class Person {
    public Person run() {
        Person person = new Person();
        return person;
    }
}
```

```java
Person.run:()LPerson;:
regs: 0002; ins: 0001; outs: 0001
  
  // 1ï¼‰åœ¨å †åŒºå®ä¾‹åŒ–ä¸€ä¸ªPersonå¯¹è±¡
  // 2ï¼‰åœ¨æ ˆåŒºç”³æ˜ä¸€ä¸ªv0å˜é‡
  // 3ï¼‰v0æŒ‡å‘Personå¯¹è±¡
  0000: new-instance v0, Person // type@0000
  
  // 1ï¼‰é€šè¿‡å–åœ°å€ç¬¦ {v0} æ‹¿åˆ°å †åŒºçš„å¯¹è±¡Person
  // 2ï¼‰è°ƒç”¨å¯¹è±¡çš„ <init> åˆå§‹åŒ–æ–¹æ³•
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
    
  // 1ï¼‰å› ä¸ºv0åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›ç»™cpu  
  0005: return-object v0
```

### 4ï¼‰å…¨å±€è¿”å›

<img src="004_å®‰å“å†…å­˜åŸç†.assets/image-20220302120151265.png" width="450" />

```java
public class Person {
    private Person person;

    public Person run() {
        person = new Person();
        return person;
    }
}
```

```java
Person.run:()LPerson;:
regs: 0002; ins: 0001; outs: 0001
  
  // 1ï¼‰åœ¨å †åŒºå®ä¾‹åŒ–ä¸€ä¸ªPersonå¯¹è±¡
  // 2ï¼‰åœ¨æ ˆåŒºç”³æ˜ä¸€ä¸ªv0å˜é‡
  // 3ï¼‰v0æŒ‡å‘Personå¯¹è±¡
  0000: new-instance v0, Person // type@0000
    
  // 1ï¼‰é€šè¿‡å–åœ°å€ç¬¦ {v0} æ‹¿åˆ°å †åŒºçš„å¯¹è±¡Person
  // 2ï¼‰è°ƒç”¨å¯¹è±¡çš„ <init> åˆå§‹åŒ–æ–¹æ³•
  0002: invoke-direct {v0}, Person.<init>:()V // method@0000
    
  // æ³¨æ„ï¼šå› ä¸ºç”³æ˜äº†ä¸€ä¸ªå…¨å±€å˜é‡Personï¼Œæ‰€ä»¥åœ¨æ–¹æ³•åŒºä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡v1
  // 			- v0åœ¨æ ˆåŒºï¼ˆé«˜é€Ÿç¼“å­˜ï¼‰ï¼ŒæŒ‡å‘Personå¯¹è±¡
  // 			- Personå¯¹è±¡åœ¨å †åŒºï¼ˆä¸»å­˜ï¼‰
  // 			- v1åœ¨æ–¹æ³•åŒºï¼ˆä¸»å­˜ï¼‰ï¼Œåœ¨æ‰§è¡Œè¯¥è¡ŒæŒ‡ä»¤å‰æš‚æ— æŒ‡å‘
  //
  // 1ï¼‰æŠŠv0çš„å€¼èµ‹å€¼ç»™v1ï¼ˆæ­¤æ—¶v1çš„å€¼å°±ç­‰äºv0ï¼Œç”±äºv0æŒ‡å‘Personå¯¹è±¡ï¼Œæ‰€ä»¥v1ä¹ŸæŒ‡å‘Personå¯¹è±¡ï¼‰
  0005: iput-object v0, v1, Person.person:LPerson; // field@0000

	// 1ï¼‰æŠŠv1çš„å€¼èµ‹å€¼ç»™v0ï¼ˆç›¸å½“äºä»£ç  v0=v1 ï¼‰
	// 
	// é‡ç‚¹ï¼šé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›v0ï¼Œè€Œè¦å¤šè¿™ä¸€æ­¥æ“ä½œå‘¢ï¼Ÿ
	// ç­”ï¼šå› ä¸ºæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œç›´æ¥è¿”å›v0ä¸å®‰å…¨ã€‚
	//    è®¾æƒ³ï¼šå‡å¦‚ç›´æ¥è¿”å›v0æ—¶ï¼Œæ­¤æ—¶v1è¢«ä¿®æ”¹æŒ‡å‘äº†å¦ä¸€ä¸ªPersonå¯¹è±¡ï¼Œè€Œv0æŒ‡å‘ä¾æ—§æ˜¯è€çš„Personå¯¹è±¡ã€‚
	//    å› æ­¤cpuä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¼šå†è¯»ä¸€év1çš„å€¼ï¼ˆå› ä¸ºcpuä¸èƒ½ç›´æ¥æ‹¿åˆ°v1çš„å€¼ï¼Œæ‰€ä»¥éœ€è¦æŠŠv1çš„å€¼èµ‹ç»™v0ï¼‰
  0007: iget-object v0, v1, Person.person:LPerson; // field@0000

  // 1ï¼‰å› ä¸ºv0åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿”å›ç»™cpu
  0009: return-object v0
```

## 4ã€ä»æŒ‡ä»¤è§’åº¦éªŒè¯androidè™šæ‹Ÿæœºçš„â€œç¼–è¯‘é¢„å¤„ç†â€

```java
// --------------------------------------------------
// 1ã€ç¼–å†™ Person.java
// --------------------------------------------------
// Person.java æ”¾åœ¨æ ¹ç›®å½•ï¼Œä¸è¦æœ‰åŒ…å
public class Person {
    public int test(){
        int a = 100;
        int b = 200;
        return a + b;
    }
}

// --------------------------------------------------
// 2ã€javac ç”Ÿæˆ Person.class 
// --------------------------------------------------
// Build -> Make Project, ç”ŸæˆPerson.classæ–‡ä»¶
// Person.classè·¯å¾„ï¼š/builld/intermediates/javac/debug/classes/Person.class
public class Person {
    public Person() {
    }

    public int test() {
        int a = 100;
        int b = 200;
        return a + b;
    }
}

// --------------------------------------------------
// 3ã€å°†.classçš„æŸä¸ªæ–¹æ³•ç¼–è¯‘æˆdexæŒ‡ä»¤
// --------------------------------------------------
// 1ï¼‰é…ç½®dxä¸´æ—¶ç¯å¢ƒå˜é‡
$ export PATH=$PATH:/Users/TaoWang/Library/Android/sdk/build-tools/26.0.2/

// 2ï¼‰è¿›å…¥åˆ° Person.class æ‰€åœ¨ç›®å½•
$ cd /Users/TaoWang/Desktop/Demo/app/build/intermediates/javac/debug/classes 

// 3ï¼‰æ‰§è¡Œdexç¼–è¯‘å‘½ä»¤ï¼Œç”ŸæˆPerson.testæ–¹æ³•çš„dexæŒ‡ä»¤
// --dexï¼šç¼–è¯‘æˆdex
// --verboseï¼šç¼–è¯‘è¿‡ç¨‹ä¸­æ‰“å°ä¿¡æ¯
// --dump-to=wata.txtï¼šè¾“å‡ºåˆ°wata.txt
// --dump-method=Person.runï¼šç¼–è¯‘çš„æ˜¯Person.runæ–¹æ³•
// --verbose-dump Person.classï¼šè¾“å…¥çš„ç±»è·¯å¾„
$ dx --dex --verbose --dump-to=wata.txt --dump-method=Person.test --verbose-dump Person.class

// 4ï¼‰åˆ å‡dexæ—¥å¿—ä¿¡æ¯åï¼Œå¾—åˆ°å¦‚ä¸‹dexæŒ‡ä»¤ï¼š
// è§‚å¯Ÿå‘ç°ï¼Œç›´æ¥è¿”å›äº†300ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œè®¡ç®—ï¼ˆä»è€ŒéªŒè¯androidè™šæ‹Ÿæœºæœ‰ç¼–è¯‘é¢„å¤„ç†ï¼ŒJVMæ²¡æœ‰ï¼‰
Person.test:()I:
regs: 0004; ins: 0001; outs: 0000
  0000: const/16 v0, #int 100 // #0064
  0002: const/16 v1, #int 200 // #00c8
  0004: const/16 v2, #int 300 // #012c
  0006: return v2
    
// --------------------------------------------------
// 4ã€è¯¥æƒ…å†µä¸‹ï¼Œæ— æ³•è¿›è¡Œç¼–è¯‘é¢„å¤„ç†
// --------------------------------------------------  
public class Person {
    public int test(int a, int b){
        return a + b;
    }
}

Person.test:(II)I:
regs: 0004; ins: 0003; outs: 0000
  0000: add-int v0, v2, v3
  0002: return v0
```

## 5ã€klassçŸ¥è¯†ç‚¹

> - å®‰å“è™šæ‹Ÿæœºæºç  class_link.cc
>
> - klass çš„ä¿¡æ¯éƒ½æ˜¯ä» class_link.cc ä¸­æ¥çš„

```java
// klassæ˜¯javaå¯¹è±¡çš„æè¿°ä¿¡æ¯ï¼ˆæ¯ä¸€ä¸ªjavaå¯¹è±¡ï¼Œéƒ½ä¼šæœ‰klassï¼‰
// klass çš„ objectSizeï¼Œæ˜¯ä¿®é¥°å¯¹è±¡åœ¨å †åŒºä¸­çš„å¤§å°ï¼Œä¸€ä¸ªç©ºå¯¹è±¡åœ¨å †åŒºä¸­å 8ä¸ªå­—èŠ‚ï¼ˆåœ¨ä¸åŒç‰ˆæœ¬çš„javaè™šæ‹Ÿæœºä¸­ï¼Œå ç”¨æœ‰æ‰€ä¸åŒï¼‰
// klass çš„ classSizeï¼Œæ˜¯ä¿®é¥°ç±»ä¿¡æ¯åœ¨æ–¹æ³•åŒºä¸­çš„å¤§å°ï¼Œä¸€ä¸ªç±»ä¿¡æ¯åœ¨æ–¹æ³•åŒºä¸­å 180ä¸ªå­—èŠ‚ï¼ˆåœ¨ä¸åŒç‰ˆæœ¬çš„javaè™šæ‹Ÿæœºä¸­ï¼Œå ç”¨æœ‰æ‰€ä¸åŒï¼‰

// --------------------------------------------------
// classSizeã€objectSize
// --------------------------------------------------

// klass çš„ classSize = 180
// klass çš„ objectSize = 8
public class Person {}

// --------------------------------------------------
// æˆå‘˜å˜é‡ï¼ˆå­˜æ”¾åœ¨å †åŒºï¼Œå±äºå¯¹è±¡ä¿¡æ¯ï¼‰
// --------------------------------------------------

// klass çš„ objectSize = 12ï¼ˆå¯¹è±¡æœ¬èº«8ä¸ªå­—èŠ‚+intç±»å‹æ‰€å çš„4ä¸ªå­—èŠ‚ï¼‰
public class Person {
    int x;
}

// klass çš„ objectSize = 16ï¼ˆå¯¹è±¡æœ¬èº«8ä¸ªå­—èŠ‚+doubleç±»å‹æ‰€å çš„8ä¸ªå­—èŠ‚ï¼‰
public class Person {
    double x;
}

// --------------------------------------------------
// é™æ€å˜é‡ï¼ˆå­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­ï¼Œå±äºç±»ä¿¡æ¯ï¼‰
// --------------------------------------------------

// klass çš„ classSize = 184ï¼ˆç±»æœ¬èº«180ä¸ªå­—èŠ‚+intæ‰€å çš„4ä¸ªå­—èŠ‚ï¼‰
public class Person {
    static int x;
}

// klass çš„ classSize = 192ï¼ˆç±»æœ¬èº«180ä¸ªå­—èŠ‚+doubleæ‰€å çš„8ä¸ªå­—èŠ‚+å†…å­˜å¯¹é½æ‰€å çš„4ä¸ªå­—èŠ‚ï¼‰
// æ³¨æ„ï¼šå†…å­˜å¯¹é½å¯ä»¥ç®€å•ç†è§£æˆï¼Œèƒ½è¢«8æ•´é™¤ã€‚ï¼ˆ188ä¸èƒ½è¢«8æ•´é™¤ï¼Œæ‰€ä»¥è¡¥é½4ä¸ªå­—èŠ‚ï¼‰
public class Person {
    static double x;
}

// klass çš„ classSize = 192ï¼ˆç±»æœ¬èº«180ä¸ªå­—èŠ‚+doubleæ‰€å çš„8ä¸ªå­—èŠ‚+intæ‰€å çš„4ä¸ªå­—èŠ‚ï¼‰
public class Person {
    static double x;
    static int 9;
}

// --------------------------------------------------
// æ–¹æ³•ï¼ˆå±äºç±»ä¿¡æ¯ï¼‰
// --------------------------------------------------

// classSize = 184ï¼ˆç±»æœ¬èº«180ä¸ªå­—èŠ‚ + æ–¹æ³•4ä¸ªå­—èŠ‚ï¼‰
// æ–¹æ³•åŠ è½½åˆ°æ–¹æ³•åŒºä¸­
// ä¸€ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ª ArtMethod å¼•ç”¨ï¼ˆæŒ‡å‘çš„æ˜¯æ–¹æ³•çš„åœ°å€ï¼‰
public class Person {
    public void run() {}
}
```

## 6ã€å†…å­˜è§’åº¦çœ‹å†…å­˜æ³„æ¼

```java
// --------------------------------------------------
// ä¼šé€ æˆ â€œå†…å­˜æ³„æ¼â€
// --------------------------------------------------
public class MainActivity extends AppCompatActivity {
  
    class Person {}
    Person person;
  
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
   
        // æ­¤æ—¶ personå¯¹è±¡ çš„ objectSize = 12ï¼ˆæœ¬èº«çš„8ä¸ªå­—èŠ‚+4ä¸ªå­—èŠ‚æ˜¯MainActivityçš„å¼•ç”¨ï¼‰
        // å› æ­¤ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼
        person = new Person();
        person.hashCode();
    }
}


// --------------------------------------------------
// ä¼šé€ æˆ â€œå†…å­˜æ³„æ¼â€
// --------------------------------------------------
public class MainActivity extends AppCompatActivity {
  
    class Person {}
    static Person person;
  
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
      
        // å†…å­˜æ³„æ¼ é€ æˆçš„åŸå› ï¼šé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡      
        // è¿™é‡Œå†…å­˜æ³„æ¼çš„åŸå› åˆ†æï¼š
        // 		personå˜é‡ è¢«staticä¿®é¥°ï¼Œå› æ­¤å­˜æ”¾åœ¨æ–¹æ³•åŒºï¼Œä¸ä¼šè¢«é”€æ¯ã€‚
        // 		personå˜é‡ æŒ‡å‘ å †åŒºçš„personå¯¹è±¡ï¼Œå †åŒºçš„personå¯¹è±¡ æŒæœ‰ MainActivityå¯¹è±¡ï¼Œ
        // 		å› æ­¤ MainActivityå¯¹è±¡ ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼
        person = new Person();
        person.hashCode();
    }
}

// --------------------------------------------------
// ä¸ä¼šå†…å­˜æ³„æ¼
// --------------------------------------------------
public class MainActivity extends AppCompatActivity {
  
    static class Person {}
    static Person person;
  
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
      
        // æ­¤æ—¶ personå¯¹è±¡ çš„ objectSize = 8ï¼ˆæœ¬èº«çš„8ä¸ªå­—èŠ‚ï¼‰
        person = new Person();
        person.hashCode();
    }
}
```

## 7ã€æŸ¥çœ‹åå°„æºç 

å®‰å“è™šæ‹Ÿæœº native æºç  class_link.cc
